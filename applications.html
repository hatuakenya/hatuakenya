<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Applications | Hatua Recruitment</title>
    <meta name="theme-color" content="#1A1A1A">

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- PDF Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* DYNAMIC VARIABLES (Hatua Branding) */
            --primary-dark: #1A1A1A; /* Charcoal */
            --accent-main: #D4AF37; /* Gold */
            --accent-glow: rgba(212, 175, 55, 0.4);
            --accent-light: #FFFBEB; /* Very light gold/yellow tint */
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            --bg-body: #F8FAFC;
            --surface-white: #ffffff;
            
            /* Status Colors */
            --st-received: #64748b;     /* Slate */
            --st-review: #0ea5e9;       /* Light Blue */
            --st-verified: #10b981;     /* Green */
            --st-shortlisted: #D4AF37;  /* Gold */
            --st-hired: #1A1A1A;        /* Charcoal */
            --st-rejected: #ef4444;     /* Red */

            --shadow-subtle: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-elevated: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            --font-main: 'Plus Jakarta Sans', sans-serif;
        }

        * {margin:0;padding:0;box-sizing:border-box; -webkit-tap-highlight-color: transparent;}

        body {
            font-family: var(--font-main);
            color: var(--text-main);
            background: url('assets/images/background.png') repeat, var(--bg-body);
            background-size: 300px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding-bottom: 80px; /* Space for floating btn */
        }

        /* ---- HEADER ---- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding: 15px 5%; position: fixed; top: 0; left: 0; right: 0;
            z-index: 1000; box-shadow: var(--shadow-subtle); border-bottom: 1px solid rgba(0,0,0,0.03);
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        header.hidden { transform: translateY(-100%); }
        
        .logo-container { display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .logo-container img { height: 40px; width: auto; }
        .logo-text { font-size: 1.4rem; font-weight: 700; color: var(--primary-dark); font-family: 'Playfair Display', serif; }

        /* ---- HAMBURGER MENU ---- */
        .hamburger-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(26, 26, 26, 0.05); color: var(--primary-dark);
            border: none; cursor: pointer; display: grid; place-items: center;
            font-size: 1.2rem; transition: var(--transition);
            position: relative; z-index: 1002;
        }
        .hamburger-btn:hover { background: rgba(212, 175, 55, 0.1); color: var(--accent-main); transform: rotate(90deg); }
        
        .nav-notification-dot {
            position: absolute; top: 8px; right: 8px; width: 10px; height: 10px; 
            background: #ef4444; border-radius: 50%; border: 2px solid #fff;
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .nav-notification-dot.show { opacity: 1; }

        /* ---- DRAWER ---- */
        .menu-overlay {
            position: fixed; inset: 0; background: rgba(26, 26, 26, 0.6);
            backdrop-filter: blur(4px); z-index: 2000; opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .menu-overlay.active { opacity: 1; pointer-events: all; }

        .side-drawer {
            position: fixed; top: 0; right: 0; bottom: 0;
            width: 80%; max-width: 320px; background: #fff; z-index: 2001;
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column;
            padding: 30px 0; border-left: 4px solid var(--accent-main);
        }
        .side-drawer.active { transform: translateX(0); }

        .drawer-header { padding: 0 25px 25px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 15px; }
        .drawer-avatar { width: 50px; height: 50px; background: var(--primary-dark); color: var(--accent-main); border-radius: 50%; display: grid; place-items: center; font-size: 1.2rem; font-weight: 700; border: 2px solid var(--accent-main); }
        .drawer-user h4 { font-size: 1.1rem; color: var(--primary-dark); margin-bottom: 2px; }
        .drawer-user p { font-size: 0.85rem; color: var(--text-muted); }
        
        .drawer-links { padding: 20px 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .drawer-item { padding: 12px 20px; border-radius: 12px; text-decoration: none; color: var(--text-main); font-weight: 600; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .drawer-item i { width: 24px; text-align: center; color: var(--text-muted); }
        .drawer-item:hover, .drawer-item.active { background: #FFFBEB; color: var(--primary-dark); }
        .drawer-item:hover i, .drawer-item.active i { color: var(--accent-main); }
        
        .drawer-badge { margin-left: auto; background: #ef4444; color: #fff; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; opacity: 0; }
        .drawer-badge.show { opacity: 1; }

        .drawer-footer { padding: 20px 25px 0; border-top: 1px solid #f1f5f9; }
        .drawer-logout { width: 100%; padding: 12px; background: #fef2f2; color: #ef4444; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: var(--font-main); transition: 0.2s; }
        .drawer-logout:hover { background: #fee2e2; }

        /* ---- PAGE CONTENT ---- */
        .container { margin-top: 100px; padding: 0 5%; max-width: 800px; margin-left: auto; margin-right: auto; }

        .page-head { margin-bottom: 30px; animation: slideUp 0.4s ease-out; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.8rem; font-family: 'Playfair Display', serif; color: var(--primary-dark); font-weight: 700; margin-bottom: 5px; }
        .page-sub { font-size: 0.95rem; color: var(--text-muted); }

        .btn-refresh { 
            background: var(--surface-white); border: 1px solid rgba(0,0,0,0.05); width: 44px; height: 44px; 
            border-radius: 50%; color: var(--primary-dark); cursor: pointer; 
            display: flex; align-items: center; justify-content: center; transition: 0.3s; 
            box-shadow: var(--shadow-subtle);
        }
        .btn-refresh:hover { background: var(--primary-dark); color: var(--accent-main); transform: rotate(180deg); }

        /* APPLICATION CARDS */
        .app-list { display: grid; gap: 24px; animation: slideUp 0.5s ease-out; }

        .app-card {
            background: var(--surface-white); border-radius: var(--radius-lg); overflow: hidden;
            box-shadow: var(--shadow-subtle); border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s; position: relative;
            cursor: pointer;
            border-top: 4px solid transparent;
        }
        .app-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-elevated); border-top-color: var(--accent-main); }
        
        .ac-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: flex-start; }
        .job-info h3 { font-size: 1.1rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 4px; }
        .job-info p { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .ac-date { font-size: 0.75rem; background: #f8fafc; padding: 6px 12px; border-radius: 20px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid #e2e8f0; }

        .ac-body { padding: 20px; }
        
        /* Status Steps Visualization */
        .status-track { display: flex; justify-content: space-between; position: relative; margin-bottom: 20px; padding: 0 5px; }
        .track-line { position: absolute; top: 6px; left: 0; right: 0; height: 3px; background: #e2e8f0; z-index: 1; border-radius: 2px; }
        .track-step { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; gap: 6px; width: 40px; }
        
        .track-dot { 
            width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; 
            border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .track-label { font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-align: center; opacity: 0; transition: 0.3s; position: absolute; top: 18px; width: 60px; pointer-events: none; }
        
        /* Active States */
        .track-step.active .track-dot { transform: scale(1.2); }
        .track-step.current .track-dot { transform: scale(1.4); box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.3); }
        .track-step.current .track-label { opacity: 1; color: var(--primary-dark); }

        .s-Received.active .track-dot { background: var(--st-received); }
        .s-Review.active .track-dot { background: var(--st-review); }
        .s-Verified.active .track-dot { background: var(--st-verified); }
        .s-Shortlisted.active .track-dot { background: var(--st-shortlisted); }
        .s-Hired.active .track-dot { background: var(--st-hired); }

        /* Current Status Badge */
        .status-badge { 
            display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; 
            border-radius: 30px; font-weight: 700; font-size: 0.85rem; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .sb-Received { background: #f1f5f9; color: var(--st-received); }
        .sb-Review { background: #e0f2fe; color: var(--st-review); }
        .sb-Verified { background: #dcfce7; color: var(--st-verified); }
        .sb-Shortlisted { background: var(--accent-light); color: var(--st-shortlisted); border: 1px solid rgba(212, 175, 55, 0.2); }
        .sb-Hired { background: var(--primary-dark); color: var(--accent-main); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .sb-Rejected { background: #fee2e2; color: var(--st-rejected); }

        .ac-footer { background: #f8fafc; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; }
        .pay-info { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display: flex; gap: 8px; align-items: center; }
        .btn-view { color: var(--primary-dark); font-weight: 700; text-decoration: none; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 6px; background: none; border: none; transition: 0.2s; }
        .btn-view:hover { color: var(--accent-main); transform: translateX(3px); }

        /* MODAL */
        .modal-bg { position: fixed; inset: 0; background: rgba(26, 26, 26, 0.7); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-bg.open { display: flex; opacity: 1; }
        .modal-card { background: white; width: 90%; max-width: 500px; border-radius: 24px; padding: 0; transform: translateY(20px); transition: transform 0.3s; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: var(--shadow-elevated); border: 1px solid rgba(0,0,0,0.1); }
        .modal-bg.open .modal-card { transform: translateY(0); }

        .m-head { padding: 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .m-title { font-size: 1.2rem; font-weight: 700; font-family: 'Playfair Display', serif; color: var(--primary-dark); }
        .m-close { font-size: 1.1rem; color: #94a3b8; cursor: pointer; background: #f1f5f9; width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; transition: 0.2s; }
        .m-close:hover { background: #fee2e2; color: var(--st-rejected); transform: rotate(90deg); }

        .m-body { padding: 25px; }

        /* Dynamic Feedback Box in Modal */
        .alert-box { padding: 20px; border-radius: 16px; margin-bottom: 25px; border-left: 4px solid transparent; display: flex; gap: 15px; align-items: flex-start; }
        .alert-box i { font-size: 1.2rem; margin-top: 2px; }
        .alert-content h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 4px; }
        .alert-content p { font-size: 0.85rem; line-height: 1.5; opacity: 0.9; }

        .ab-Review { background: #e0f2fe; border-color: var(--st-review); color: #0369a1; }
        .ab-Verified { background: #dcfce7; border-color: var(--st-verified); color: #15803d; }
        .ab-Shortlisted { background: var(--accent-light); border-color: var(--st-shortlisted); color: #854d0e; }
        .ab-Hired { background: var(--primary-dark); border-color: var(--accent-main); color: white; }
        .ab-Rejected { background: #fef2f2; border-color: var(--st-rejected); color: #991b1b; }
        .ab-Pending { background: #f1f5f9; border-color: #94a3b8; color: #475569; }

        .info-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .ig-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #e2e8f0; }
        .ig-lbl { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; }
        .ig-val { color: var(--primary-dark); font-weight: 700; font-size: 0.9rem; text-align: right; }

        .m-actions { padding: 25px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: grid; gap: 12px; }
        .act-btn { padding: 14px; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; transition: 0.2s; font-family: var(--font-main); }
        .act-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .btn-receipt { background: white; border: 1px solid #cbd5e1; color: var(--primary-dark); }
        .btn-wa { background: #25D366; color: white; border: none; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3); }

        /* Floating Support */
        .floating-support-btn {
            position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px;
            background: var(--primary-dark); color: var(--accent-main); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 990;
            text-decoration: none; transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            border: 2px solid var(--accent-main);
        }
        .floating-support-btn.hidden { transform: translateY(200%); }
        .floating-support-btn:hover { transform: scale(1.1) rotate(10deg); background: #000; color: #fff; }
        
        .support-badge {
            position: absolute; top: -2px; right: -2px;
            background: #ef4444; color: white; font-size: 0.7rem; font-weight: 800;
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff; opacity: 0; transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .support-badge.show { opacity: 1; transform: scale(1); animation: bounceIn 0.5s; }

        /* Loader & Animations */
        #page-loader { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; transition:opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--accent-main); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounceIn { 0%{transform:scale(0);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }

    </style>
</head>
<body>

    <div id="page-loader"><div class="spinner"></div></div>

    <!-- HEADER -->
    <header id="header">
        <a href="dashboard.html" class="logo-container">
            <img src="assets/images/logo.png" alt="Logo">
            <span class="logo-text" id="headerAppName">Hatua Recruitment</span>
        </a>
        <button class="hamburger-btn" id="menuTrigger">
            <i class="fas fa-bars"></i>
            <div class="nav-notification-dot" id="menuBadge"></div>
        </button>
    </header>

    <!-- DRAWER -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <aside class="side-drawer" id="sideDrawer">
        <div class="drawer-header">
            <div class="drawer-avatar" id="drawerAvatar">M</div>
            <div class="drawer-user">
                <h4 id="drawerName">Member</h4>
                <p>Hatua Member</p>
            </div>
        </div>
        
        <div class="drawer-links">
            <a href="dashboard.html" class="drawer-item"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="jobs.html" class="drawer-item"><i class="fas fa-briefcase"></i> Browse Jobs</a>
            <a href="notifications.html" class="drawer-item">
                <i class="fas fa-bell"></i> Notifications
                <span class="drawer-badge" id="drawerAlertBadge">0</span>
            </a>
            <a href="saved-jobs.html" class="drawer-item"><i class="fas fa-bookmark"></i> Saved Jobs</a>
            <a href="applications.html" class="drawer-item active"><i class="fas fa-paper-plane"></i> My Applications</a>
            <a href="messages.html" class="drawer-item"><i class="fas fa-comment-dots"></i> Messages</a>
            <a href="settings.html" class="drawer-item"><i class="fas fa-cog"></i> Settings</a>
            <a href="profile.html" class="drawer-item"><i class="fas fa-user"></i> My Profile</a>
        </div>

        <div class="drawer-footer">
            <button id="logoutBtn" class="drawer-logout">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
        </div>
    </aside>

    <div class="container">
        <div class="page-head">
            <div>
                <h1 class="page-title">My Applications</h1>
                <p class="page-sub">Track your verification progress and payment status.</p>
            </div>
            <button class="btn-refresh" onclick="window.location.reload()" title="Refresh List"><i class="fas fa-sync-alt"></i></button>
        </div>

        <div id="appList" class="app-list">
            <!-- Cards will be injected here -->
        </div>
        
        <div id="emptyState" style="text-align:center; padding:60px 20px; display:none; color:#94a3b8;">
            <div style="width:80px; height:80px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                <i class="fas fa-folder-open" style="font-size:2rem; opacity:0.5;"></i>
            </div>
            <h3 style="color:var(--primary-dark); font-size:1.1rem; margin-bottom:5px;">No Applications Yet</h3>
            <p style="font-size:0.9rem;">Browse available jobs and start applying today.</p>
            <a href="jobs.html" style="display:inline-block; margin-top:20px; color:var(--accent-main); font-weight:700; text-decoration:none;">Browse Jobs <i class="fas fa-arrow-right"></i></a>
        </div>
    </div>

    <!-- DETAILS MODAL -->
    <div id="detailsModal" class="modal-bg">
        <div class="modal-card">
            <div class="m-head">
                <div class="m-title">Application Details</div>
                <div class="m-close" onclick="closeModal()"><i class="fas fa-times"></i></div>
            </div>
            
            <div class="m-body" id="modalBody">
                <!-- Dynamic Content -->
            </div>

            <div class="m-actions">
                <button class="act-btn btn-receipt" onclick="downloadReceipt()">
                    <i class="fas fa-file-download"></i> Download Receipt
                </button>
                <button class="act-btn btn-wa" onclick="contactSupport()">
                    <i class="fab fa-whatsapp"></i> WhatsApp Support
                </button>
            </div>
        </div>
    </div>

    <!-- FLOATING SUPPORT BUTTON -->
    <a href="support.html" class="floating-support-btn" id="floatingSupportBtn">
        <i class="fas fa-headset"></i>
        <div class="support-badge" id="supportBadge">0</div>
    </a>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { auth, db } from './config.js'; 
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
        import { collection, query, where, orderBy, onSnapshot, doc, getDoc } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

        const appList = document.getElementById('appList');
        const emptyState = document.getElementById('emptyState');
        const modal = document.getElementById('detailsModal');
        const modalBody = document.getElementById('modalBody');
        const loader = document.getElementById('page-loader');
        const headerAppName = document.getElementById('headerAppName');

        // Drawer Elements
        const menuTrigger = document.getElementById('menuTrigger');
        const sideDrawer = document.getElementById('sideDrawer');
        const menuOverlay = document.getElementById('menuOverlay');
        const logoutBtn = document.getElementById('logoutBtn');
        const drawerName = document.getElementById('drawerName');
        const drawerAvatar = document.getElementById('drawerAvatar');
        const menuBadge = document.getElementById('menuBadge');
        const drawerAlertBadge = document.getElementById('drawerAlertBadge');
        const supportBadge = document.getElementById('supportBadge');

        let currentApp = null;
        let supportPhone = '254700000000'; // Default

        // 1. DRAWER LOGIC
        function toggleDrawer() {
            sideDrawer.classList.toggle('active');
            menuOverlay.classList.toggle('active');
        }
        function closeDrawer() {
            sideDrawer.classList.remove('active');
            menuOverlay.classList.remove('active');
        }
        menuTrigger.addEventListener('click', toggleDrawer);
        menuOverlay.addEventListener('click', closeDrawer);
        sideDrawer.querySelectorAll('a').forEach(l => l.addEventListener('click', closeDrawer));

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = "signin.html";
        });

        // 2. AUTH & INIT
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Update Drawer Profile
                    const uDoc = await getDoc(doc(db, "users", user.uid));
                    const name = user.displayName || (uDoc.exists() ? uDoc.data().fullName : "Member");
                    drawerName.textContent = name;
                    drawerAvatar.textContent = name.charAt(0).toUpperCase();

                    loadAppConfig();
                    setupNotificationListener(user.uid);
                    setupSupportListener(user.uid);
                } catch(e) {}

                loadApplications(user.uid);
                setTimeout(() => {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display='none', 500);
                }, 1000);
            } else window.location.href = "signin.html";
        });

        // 3. CONFIG LOGIC
        async function loadAppConfig() {
            try {
                // Branding
                const brandSnap = await getDoc(doc(db, "settings", "branding"));
                if (brandSnap.exists()) {
                    const data = brandSnap.data();
                    headerAppName.textContent = data.appName || 'Hatua Recruitment';
                    if(data.primaryColor) document.documentElement.style.setProperty('--primary-dark', data.primaryColor);
                    if(data.fontFamily) document.documentElement.style.setProperty('--font-main', `${data.fontFamily}, sans-serif`);
                }
                // Support Number
                const s = await getDoc(doc(db, "settings", "signup_page"));
                if(s.exists() && s.data().whatsappNumber) supportPhone = s.data().whatsappNumber;
            } catch (e) { console.error("Config Error", e); }
        }

        // 4. NOTIFICATION & BADGES
        function setupNotificationListener(userId) {
            getDoc(doc(db, "settings", "notifications")).then(snap => {
                if(snap.exists() && snap.data().killSwitch) return;
                const q = query(collection(db, "notifications"), where("userId", "==", userId), where("read", "==", false));
                onSnapshot(q, (snapshot) => {
                    const count = snapshot.size;
                    if(count > 0) {
                        menuBadge.classList.add('show');
                        drawerAlertBadge.textContent = count > 9 ? '9+' : count;
                        drawerAlertBadge.classList.add('show');
                    } else {
                        menuBadge.classList.remove('show');
                        drawerAlertBadge.classList.remove('show');
                    }
                });
            });
        }

        function setupSupportListener(userId) {
            const q = query(collection(db, "support_tickets"), where("userId", "==", userId), where("hasUnreadUser", "==", true));
            onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                if(count > 0) {
                    supportBadge.textContent = count;
                    supportBadge.classList.add('show');
                } else {
                    supportBadge.classList.remove('show');
                }
            });
        }

        // 5. LOAD APPS
        function loadApplications(uid) {
            // Note: Requires Index (userId ASC, appliedAt DESC)
            const q = query(collection(db, "applications"), where("userId", "==", uid), orderBy("appliedAt", "desc"));
            
            onSnapshot(q, (snap) => {
                appList.innerHTML = '';
                if (snap.empty) { emptyState.style.display = 'block'; return; }
                emptyState.style.display = 'none';

                snap.forEach(d => {
                    const app = { id: d.id, ...d.data() };
                    renderCard(app);
                });
            });
        }

        // 6. RENDER CARD
        function renderCard(app) {
            const date = app.appliedAt ? new Date(app.appliedAt.seconds*1000).toLocaleDateString() : 'N/A';
            const status = app.status || 'Received';

            // Determine Status Styling
            let sIcon = 'fa-clock';
            let sClass = 'sb-Received';
            
            if(status === 'Under Review') { sIcon = 'fa-search'; sClass = 'sb-Review'; }
            else if(status === 'Verified') { sIcon = 'fa-check-circle'; sClass = 'sb-Verified'; }
            else if(status === 'Shortlisted') { sIcon = 'fa-star'; sClass = 'sb-Shortlisted'; }
            else if(status === 'Hired') { sIcon = 'fa-trophy'; sClass = 'sb-Hired'; }
            else if(status === 'Rejected') { sIcon = 'fa-times-circle'; sClass = 'sb-Rejected'; }

            // Progress Tracker Logic
            const steps = ['Received', 'Under Review', 'Verified', 'Shortlisted', 'Hired'];
            let dotsHTML = '';
            
            if (status === 'Rejected') {
                dotsHTML = `<div style="height:4px; background:#fee2e2; border-radius:2px; width:100%;"></div>`;
            } else {
                let currentIdx = steps.indexOf(status);
                if(currentIdx === -1) currentIdx = 0; 

                dotsHTML = `<div class="track-line"></div>`;
                steps.forEach((st, idx) => {
                    let active = idx <= currentIdx ? 'active' : '';
                    let current = idx === currentIdx ? 'current' : '';
                    let dotClass = `s-${st.replace(' ','')}`;
                    
                    dotsHTML += `
                        <div class="track-step ${dotClass} ${active} ${current}">
                            <div class="track-dot"></div>
                            <div class="track-label">${st.replace('Under ', '')}</div>
                        </div>`;
                });
            }

            // Payment Info
            let payText = `<i class="fas fa-hourglass-half"></i> Pending Check`;
            let payColor = '#64748b';
            
            if(status === 'Under Review') {
                payText = `<i class="fas fa-sync fa-spin" style="font-size:0.8rem"></i> Verifying Code...`;
                payColor = '#0369a1';
            } else if(status === 'Verified' || status === 'Shortlisted' || status === 'Hired' || app.paymentStatus === 'Verified') {
                payText = `<i class="fas fa-check-double"></i> Payment Verified`;
                payColor = '#15803d';
            } else if(status === 'Rejected') {
                payText = `<i class="fas fa-ban"></i> Application Closed`;
                payColor = '#991b1b';
            }

            const html = `
                <div class="app-card" onclick="openModal('${encodeURIComponent(JSON.stringify(app))}')">
                    <div class="ac-header">
                        <div class="job-info">
                            <h3>${app.jobTitle}</h3>
                            <p><i class="fas fa-building"></i> ${app.companyName || 'Inc'}</p>
                        </div>
                        <div class="ac-date">${date}</div>
                    </div>
                    
                    <div class="ac-body">
                        <div class="status-track">
                            ${dotsHTML}
                        </div>
                        <div class="status-badge ${sClass}">
                            <i class="fas ${sIcon}"></i> ${status}
                        </div>
                    </div>

                    <div class="ac-footer">
                        <div class="pay-info" style="color:${payColor}">
                           ${payText}
                        </div>
                        <button class="btn-view">Details <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            `;
            appList.insertAdjacentHTML('beforeend', html);
        }

        // 7. MODAL LOGIC
        window.openModal = (encoded) => {
            currentApp = JSON.parse(decodeURIComponent(encoded));
            const st = currentApp.status || 'Received';

            // DYNAMIC ALERT BOX
            let alertClass = 'ab-Pending';
            let alertIcon = 'fa-info-circle';
            let alertTitle = 'Application Received';
            let alertMsg = 'Your application has been received. Please wait while we queue it for review.';
            
            if(st === 'Under Review') {
                alertClass = 'ab-Review';
                alertIcon = 'fa-search';
                alertTitle = 'Under Review';
                alertMsg = 'Our team is currently verifying your payment code and application details.';
            } else if(st === 'Verified') {
                alertClass = 'ab-Verified';
                alertIcon = 'fa-check-circle';
                alertTitle = 'Payment Verified';
                alertMsg = 'Great news! Your payment is confirmed valid. Your application is now in the candidate pool.';
            } else if(st === 'Shortlisted') {
                alertClass = 'ab-Shortlisted';
                alertIcon = 'fa-star';
                alertTitle = 'You are Shortlisted!';
                alertMsg = 'Congratulations! You have been shortlisted for this role. Prepare for potential contact.';
            } else if(st === 'Hired') {
                alertClass = 'ab-Hired';
                alertIcon = 'fa-trophy';
                alertTitle = 'Congratulations! You are Hired';
                alertMsg = 'You have been selected for this position. HR will contact you shortly via WhatsApp/Email.';
            } else if(st === 'Rejected') {
                alertClass = 'ab-Rejected';
                alertIcon = 'fa-exclamation-triangle';
                alertTitle = 'Application Unsuccessful';
                alertMsg = `Reason: ${currentApp.rejectReason || "Criteria not met."}`;
            }

            modalBody.innerHTML = `
                <div class="alert-box ${alertClass}">
                    <i class="fas ${alertIcon}"></i>
                    <div class="alert-content">
                        <h4>${alertTitle}</h4>
                        <p>${alertMsg}</p>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="ig-row">
                        <span class="ig-lbl">Job Title</span>
                        <span class="ig-val">${currentApp.jobTitle}</span>
                    </div>
                    <div class="ig-row">
                        <span class="ig-lbl">Reference ID</span>
                        <span class="ig-val">#${currentApp.id.slice(-6).toUpperCase()}</span>
                    </div>
                    <div class="ig-row">
                        <span class="ig-lbl">M-Pesa Code</span>
                        <span class="ig-val" style="font-family:monospace; background:#f1f5f9; padding:2px 6px; border-radius:4px;">${currentApp.mpesaCode}</span>
                    </div>
                    <div class="ig-row">
                        <span class="ig-lbl">Payment Status</span>
                        <span class="ig-val">${currentApp.paymentStatus || (st==='Rejected'?'Rejected':'Pending')}</span>
                    </div>
                    <div class="ig-row" style="border:none">
                        <span class="ig-lbl">Applied On</span>
                        <span class="ig-val">${new Date(currentApp.appliedAt.seconds*1000).toDateString()}</span>
                    </div>
                </div>
            `;
            modal.classList.add('open');
        };

        window.closeModal = () => modal.classList.remove('open');

        // 8. ACTIONS
        window.downloadReceipt = () => {
            if(!currentApp) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFillColor(26, 26, 26); 
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(212, 175, 55); 
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text(headerAppName.textContent, 14, 25);
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Official Application Receipt", 14, 32);
            
            const data = [
                ["Application ID", `#${currentApp.id.toUpperCase()}`],
                ["Candidate Name", drawerName.textContent], // Using name from drawer
                ["Position Applied", currentApp.jobTitle],
                ["Company", currentApp.companyName || 'N/A'],
                ["M-Pesa Code", currentApp.mpesaCode],
                ["Current Status", currentApp.status],
                ["Application Date", new Date(currentApp.appliedAt.seconds*1000).toLocaleString()]
            ];

            doc.autoTable({
                startY: 50,
                head: [['Field', 'Details']],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [26, 26, 26] },
                styles: { fontSize: 11, cellPadding: 6 }
            });

            // Watermark
            if(currentApp.status === 'Hired') {
                doc.setTextColor(212, 175, 55); doc.setFontSize(40); doc.saveGraphicsState(); doc.setGState(new doc.GState({opacity: 0.1}));
                doc.text("HIRED", 105, 150, {angle: 45, align:'center'}); doc.restoreGraphicsState();
            } else if(currentApp.status === 'Verified') {
                doc.setTextColor(16, 185, 129); doc.setFontSize(40); doc.saveGraphicsState(); doc.setGState(new doc.GState({opacity: 0.1}));
                doc.text("VERIFIED", 105, 150, {angle: 45, align:'center'}); doc.restoreGraphicsState();
            }

            doc.save(`Receipt_${currentApp.mpesaCode}.pdf`);
        };

        window.contactSupport = () => {
            const msg = `Hello Support, I need assistance with my application #${currentApp.id.slice(-6).toUpperCase()} for the ${currentApp.jobTitle} position.`;
            window.open(`https://wa.me/${supportPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        // Scroll Auto-Hide Logic
        const header = document.getElementById('header');
        const floatingSupportBtn = document.getElementById('floatingSupportBtn');
        let lastScroll = 0;
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            if (currentScroll <= 0) {
                header.classList.remove('hidden');
                floatingSupportBtn.classList.remove('hidden');
            } else {
                if (currentScroll > lastScroll && currentScroll > 60) {
                    header.classList.add('hidden');
                    floatingSupportBtn.classList.add('hidden');
                } else {
                    header.classList.remove('hidden');
                    floatingSupportBtn.classList.remove('hidden');
                }
            }
            lastScroll = currentScroll;
        });

    </script>
</body>
</html>
