<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Resume Builder | Hatua Recruitment</title>
    <meta name="theme-color" content="#1A1A1A">

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* HATUA BRANDING */
            --primary-dark: #1A1A1A;    /* Charcoal */
            --primary-light: #2C2C2C;
            --accent-main: #D4AF37;     /* Gold */
            --accent-light: #FFFBEB;    /* Light Gold BG */
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            --bg-body: #F8FAFC;
            --surface-white: #ffffff;
            
            --shadow-subtle: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-elevated: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-serif: 'Playfair Display', serif;
        }

        * {margin:0;padding:0;box-sizing:border-box; -webkit-tap-highlight-color: transparent;}

        body {
            font-family: var(--font-main);
            color: var(--text-main);
            background: url('assets/images/background.png') repeat, var(--bg-body);
            background-size: 300px;
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        /* ---- HEADER ---- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass-bg); backdrop-filter: blur(16px);
            padding: 15px 5%; position: fixed; top: 0; left: 0; right: 0;
            z-index: 1000; box-shadow: var(--shadow-subtle); border-bottom: 1px solid rgba(0,0,0,0.03);
        }

        .logo-con { display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .logo-con img { height: 35px; width: auto; }
        .logo-text { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); font-family: var(--font-serif); }

        .hamburger-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(26, 26, 26, 0.05); color: var(--primary-dark);
            border: none; cursor: pointer; display: grid; place-items: center;
            font-size: 1.2rem; transition: var(--transition);
        }
        .hamburger-btn:hover { background: rgba(212, 175, 55, 0.1); color: var(--accent-main); transform: rotate(90deg); }

        /* ---- DRAWER ---- */
        .menu-overlay {
            position: fixed; inset: 0; background: rgba(26, 26, 26, 0.6);
            backdrop-filter: blur(4px); z-index: 2000; opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .menu-overlay.active { opacity: 1; pointer-events: all; }

        .side-drawer {
            position: fixed; top: 0; right: 0; bottom: 0;
            width: 80%; max-width: 320px;
            background: #fff; z-index: 2001;
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; padding: 30px 0; border-left: 4px solid var(--accent-main);
        }
        .side-drawer.active { transform: translateX(0); }

        .drawer-header { padding: 0 25px 25px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 15px; }
        .drawer-avatar { width: 50px; height: 50px; background: var(--primary-dark); color: var(--accent-main); border-radius: 50%; display: grid; place-items: center; font-size: 1.2rem; font-weight: 700; border: 2px solid var(--accent-main); }
        .drawer-user h4 { font-size: 1.1rem; color: var(--primary-dark); margin-bottom: 2px; }
        .drawer-user p { font-size: 0.85rem; color: var(--text-muted); }

        .drawer-links { padding: 20px 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .drawer-item { padding: 12px 20px; border-radius: 12px; text-decoration: none; color: #1e293b; font-weight: 600; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .drawer-item i { width: 24px; text-align: center; color: #64748b; transition: 0.2s; }
        .drawer-item:hover, .drawer-item.active { background: var(--accent-light); color: var(--primary-dark); }
        .drawer-item:hover i, .drawer-item.active i { color: var(--accent-main); }
        
        .drawer-footer { padding: 20px 25px 0; border-top: 1px solid #f1f5f9; }
        .drawer-logout { width: 100%; padding: 12px; background: #fef2f2; color: #ef4444; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; font-family: var(--font-main); }
        .drawer-logout:hover { background: #fee2e2; }

        /* ---- BUILDER CONTAINER ---- */
        .main-container {
            margin-top: 80px; padding: 20px 5%; max-width: 1400px; margin-left: auto; margin-right: auto; width: 100%;
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
            height: calc(100vh - 100px);
        }

        /* 1. BUILDER PANEL (LEFT) */
        .builder-panel {
            background: #fff; border-radius: var(--radius-lg); padding: 30px;
            box-shadow: var(--shadow-subtle); border: 1px solid rgba(0,0,0,0.04);
            overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
            height: 100%;
        }
        .builder-panel::-webkit-scrollbar { width: 6px; }
        .builder-panel::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .panel-header { margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 20px; }
        .panel-title { font-family: var(--font-serif); font-size: 1.8rem; color: var(--primary-dark); margin-bottom: 5px; }

        /* Accordion Sections */
        .form-section { border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; transition: 0.3s; background: #fff; }
        .form-section:hover { border-color: #cbd5e1; }
        
        .section-trigger {
            width: 100%; padding: 18px 24px; background: #fff; border: none;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 700; color: var(--primary-dark); cursor: pointer; font-size: 1rem;
            transition: 0.2s; border-bottom: 1px solid transparent;
        }
        .section-trigger:hover { background: #f8fafc; color: var(--accent-main); }
        .section-trigger.active { border-bottom-color: #e2e8f0; background: #fdfdfd; }
        .section-trigger i.fa-chevron-down { transition: transform 0.3s ease; }
        .section-trigger.active i.fa-chevron-down { transform: rotate(180deg); }

        .section-content { padding: 24px; display: none; background: #fff; }
        .section-content.open { display: block; animation: slideDown 0.3s ease; }

        /* Inputs */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 0; }
        .form-group.full { grid-column: 1 / -1; }
        
        label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, textarea, select {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #cbd5e1;
            font-family: var(--font-main); font-size: 0.95rem; transition: 0.2s; background: #f8fafc; color: var(--primary-dark);
        }
        input:focus, textarea:focus { background: #fff; border-color: var(--accent-main); outline: none; box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.15); }
        textarea { resize: vertical; min-height: 100px; line-height: 1.5; }

        /* Dynamic Lists */
        .dynamic-list-item { 
            background: #fff; padding: 25px; border-radius: 16px; 
            border: 1px solid #e2e8f0; margin-bottom: 20px; position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: transform 0.2s;
        }
        .dynamic-list-item:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
        
        .remove-btn {
            position: absolute; top: 15px; right: 15px; color: #ef4444; background: #fef2f2; 
            width: 32px; height: 32px; border-radius: 50%; border: 1px solid #fee2e2; cursor: pointer;
            display: grid; place-items: center; transition: 0.2s; font-size: 0.9rem;
        }
        .remove-btn:hover { background: #fee2e2; transform: scale(1.1); color: #dc2626; }

        .add-btn {
            background: #fff; border: 2px dashed #cbd5e1; color: var(--text-muted);
            width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
            font-size: 0.95rem; margin-top: 10px;
        }
        .add-btn:hover { border-color: var(--accent-main); color: var(--accent-main); background: var(--accent-light); }

        /* 2. PREVIEW PANEL (RIGHT) */
        .preview-wrapper {
            background: #334155; border-radius: var(--radius-lg); padding: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            height: 100%; overflow: hidden; position: relative; border: 1px solid #475569;
        }
        
        .preview-controls {
            position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10;
        }
        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer;
            background: rgba(255,255,255,0.15); color: white; backdrop-filter: blur(5px);
            display: grid; place-items: center; transition: 0.2s;
        }
        .ctrl-btn:hover { background: var(--accent-main); color: var(--primary-dark); transform: scale(1.1); }

        /* A4 PAPER */
        .resume-container-scroll {
            width: 100%; height: 100%; overflow: auto; display: flex; justify-content: center; padding-top: 20px;
        }
        .resume-container-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .resume-container-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        #resumePreview {
            width: 210mm; min-height: 297mm; /* A4 */
            background: white; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            /* Scaling handled via transform on wrapper or zoom */
            padding: 40px;
            color: #333; font-family: 'Merriweather', serif;
            display: flex; flex-direction: column;
            transform-origin: top center;
        }

        /* Resume Template Styles */
        .res-header { border-bottom: 3px solid var(--primary-dark); padding-bottom: 25px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .res-name { font-size: 2.2rem; font-weight: 700; color: var(--primary-dark); text-transform: uppercase; letter-spacing: 1px; line-height: 1.1; font-family: var(--font-main); }
        .res-role { font-size: 1.1rem; color: var(--accent-main); font-weight: 700; margin-top: 8px; font-family: var(--font-main); text-transform: uppercase; letter-spacing: 2px; }
        
        .res-contact { text-align: right; font-size: 0.85rem; line-height: 1.7; color: #555; font-family: var(--font-main); }
        .res-contact div { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .res-contact i { color: var(--accent-main); font-size: 0.9rem; width: 15px; text-align: center; }

        .res-section { margin-bottom: 30px; }
        .res-section-title { 
            font-size: 0.95rem; font-weight: 800; color: var(--primary-dark); 
            border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 18px;
            text-transform: uppercase; letter-spacing: 1.5px; font-family: var(--font-main);
            display: flex; align-items: center; gap: 10px;
        }
        .res-section-title i { color: var(--accent-main); }

        .res-item { margin-bottom: 20px; break-inside: avoid; }
        .res-item-head { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: baseline; }
        .res-item-title { font-weight: 700; font-size: 1.05rem; color: #1a1a1a; }
        .res-item-sub { font-style: italic; color: #64748b; font-size: 0.95rem; font-family: var(--font-main); }
        .res-item-date { font-size: 0.8rem; font-weight: 700; font-family: var(--font-main); color: var(--primary-dark); background: #f1f5f9; padding: 2px 8px; border-radius: 4px; }
        .res-desc { font-size: 0.9rem; line-height: 1.65; color: #334155; margin-top: 8px; white-space: pre-line; }

        .res-skills-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .res-skill-tag { background: #fff; border: 1px solid #cbd5e1; padding: 6px 14px; font-size: 0.85rem; font-family: var(--font-main); font-weight: 600; color: var(--primary-dark); border-radius: 30px; }

        /* Action Bar */
        .action-bar { margin-top: auto; display: flex; gap: 15px; padding-top: 25px; border-top: 1px solid #f1f5f9; }
        .btn-primary {
            flex: 2; padding: 16px; background: var(--primary-dark); color: #fff; border: none; border-radius: 14px;
            font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); font-size: 1rem; letter-spacing: 0.5px;
        }
        .btn-primary:hover { background: var(--accent-main); color: #fff; transform: translateY(-2px); }
        
        .btn-secondary {
            flex: 1; padding: 16px; background: #fff; border: 2px solid #e2e8f0; border-radius: 14px;
            font-weight: 700; cursor: pointer; color: var(--text-main); transition: 0.2s; font-size: 1rem;
        }
        .btn-secondary:hover { border-color: var(--primary-dark); background: #f8fafc; color: var(--primary-dark); }

        /* Loader */
        #page-loader { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--accent-main); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        /* Mobile Responsive */
        @media (max-width: 1100px) {
            .main-container { grid-template-columns: 1fr; height: auto; display: block; }
            .builder-panel { height: auto; margin-bottom: 30px; }
            .preview-wrapper { height: auto; padding: 40px 10px; background: #334155; margin-bottom: 30px; border-radius: 20px; }
            .resume-container-scroll { display: block; overflow: hidden; height: auto; }
            #resumePreview { transform: scale(0.48); margin: 0 auto; margin-top: -300px; margin-bottom: -350px; }
        }

    </style>
</head>
<body>

    <div id="page-loader"><div class="spinner"></div></div>

    <!-- HEADER -->
    <header id="header">
        <a href="dashboard.html" class="logo-con">
            <img src="assets/images/logo.png" alt="Logo">
            <span class="logo-text" id="headerAppName">Hatua Recruitment</span>
        </a>
        <button class="hamburger-btn" id="menuTrigger">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <!-- DRAWER -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <aside class="side-drawer" id="sideDrawer">
        <div class="drawer-header">
            <div class="drawer-avatar" id="drawerAvatar">M</div>
            <div class="drawer-user">
                <h4 id="drawerName">Member</h4>
                <p>Candidate Account</p>
            </div>
        </div>
        
        <div class="drawer-links">
            <a href="dashboard.html" class="drawer-item"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="jobs.html" class="drawer-item"><i class="fas fa-briefcase"></i> Browse Jobs</a>
            <a href="notifications.html" class="drawer-item"><i class="fas fa-bell"></i> Notifications</a>
            <a href="saved-jobs.html" class="drawer-item"><i class="fas fa-bookmark"></i> Saved Jobs</a>
            <a href="applications.html" class="drawer-item"><i class="fas fa-paper-plane"></i> My Applications</a>
            <a href="resume.html" class="drawer-item active"><i class="fas fa-file-alt"></i> Resume Builder</a>
            <a href="messages.html" class="drawer-item"><i class="fas fa-comment-dots"></i> Messages</a>
            <a href="settings.html" class="drawer-item"><i class="fas fa-cog"></i> Settings</a>
            <a href="profile.html" class="drawer-item"><i class="fas fa-user"></i> My Profile</a>
        </div>

        <div class="drawer-footer">
            <button id="logoutBtn" class="drawer-logout">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
        </div>
    </aside>

    <div class="main-container">
        
        <!-- LEFT: BUILDER FORM -->
        <div class="builder-panel">
            <div class="panel-header">
                <h1 class="panel-title">Resume Builder</h1>
                <p style="color:var(--text-muted); font-size:0.95rem;">Fill in your details to create a professional CV.</p>
            </div>

            <!-- 1. Personal Info -->
            <div class="form-section">
                <button class="section-trigger active" onclick="toggleSection('sec-personal', this)">
                    <span><i class="fas fa-user-circle" style="margin-right:12px; color:#94a3b8;"></i> Personal Information</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="section-content open" id="sec-personal">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="inpName" placeholder="e.g. John Doe" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Job Title</label>
                            <input type="text" id="inpRole" placeholder="e.g. Software Engineer" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="inpEmail" placeholder="john@example.com" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="inpPhone" placeholder="+254 700 000000" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="inpLoc" placeholder="City, Country" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>LinkedIn / Portfolio</label>
                            <input type="text" id="inpLink" placeholder="linkedin.com/in/johndoe" oninput="updatePreview()">
                        </div>
                        <div class="form-group full">
                            <label>Professional Summary</label>
                            <textarea id="inpSummary" placeholder="Brief overview of your career..." oninput="updatePreview()"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Education -->
            <div class="form-section">
                <button class="section-trigger" onclick="toggleSection('sec-edu', this)">
                    <span><i class="fas fa-graduation-cap" style="margin-right:12px; color:#94a3b8;"></i> Education</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="section-content" id="sec-edu">
                    <!-- Dynamic Container for Education Items -->
                    <div id="eduListContainer"></div>
                    
                    <button class="add-btn" id="addEduBtn">
                        <i class="fas fa-plus-circle"></i> Add Education
                    </button>
                </div>
            </div>

            <!-- 3. Experience -->
            <div class="form-section">
                <button class="section-trigger" onclick="toggleSection('sec-exp', this)">
                    <span><i class="fas fa-briefcase" style="margin-right:12px; color:#94a3b8;"></i> Work Experience</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="section-content" id="sec-exp">
                    <!-- Dynamic Container for Experience Items -->
                    <div id="expListContainer"></div>

                    <button class="add-btn" id="addExpBtn">
                        <i class="fas fa-plus-circle"></i> Add Experience
                    </button>
                </div>
            </div>

            <!-- 4. Skills -->
            <div class="form-section">
                <button class="section-trigger" onclick="toggleSection('sec-skills', this)">
                    <span><i class="fas fa-tools" style="margin-right:12px; color:#94a3b8;"></i> Skills</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="section-content" id="sec-skills">
                    <div class="form-group">
                        <label>List your skills (comma separated)</label>
                        <textarea id="inpSkills" placeholder="e.g. JavaScript, Project Management, Graphic Design, Leadership..." oninput="updatePreview()"></textarea>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn-secondary" onclick="saveResume()"><i class="fas fa-save"></i> Save Draft</button>
                <button class="btn-primary" onclick="downloadPDF()">Download PDF <i class="fas fa-file-download"></i></button>
            </div>
        </div>

        <!-- RIGHT: LIVE PREVIEW -->
        <div class="preview-wrapper">
            <div class="preview-controls">
                <button class="ctrl-btn" onclick="zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button>
                <button class="ctrl-btn" onclick="zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
            </div>

            <div class="resume-container-scroll">
                <div id="resumePreview">
                    <div class="res-header">
                        <div style="flex:1">
                            <div class="res-name" id="prevName">YOUR NAME</div>
                            <div class="res-role" id="prevRole">PROFESSIONAL TITLE</div>
                        </div>
                        <div class="res-contact">
                            <div id="prevEmail">email@example.com <i class="fas fa-envelope"></i></div>
                            <div id="prevPhone">+254 700 000000 <i class="fas fa-phone"></i></div>
                            <div id="prevLoc">City, Country <i class="fas fa-map-marker-alt"></i></div>
                            <div id="prevLink">linkedin.com/in/you <i class="fab fa-linkedin"></i></div>
                        </div>
                    </div>

                    <div class="res-section">
                        <div class="res-section-title"><i class="fas fa-user"></i> Professional Profile</div>
                        <div class="res-desc" id="prevSummary">A dedicated professional with experience in...</div>
                    </div>

                    <div class="res-section">
                        <div class="res-section-title"><i class="fas fa-briefcase"></i> Experience</div>
                        <div id="prevExpList">
                            <!-- Dynamic Content -->
                        </div>
                    </div>

                    <div class="res-section">
                        <div class="res-section-title"><i class="fas fa-graduation-cap"></i> Education</div>
                        <div id="prevEduList">
                            <!-- Dynamic Content -->
                        </div>
                    </div>

                    <div class="res-section">
                        <div class="res-section-title"><i class="fas fa-tools"></i> Skills</div>
                        <div class="res-skills-grid" id="prevSkills">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOASTIFY JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script type="module">
        import { auth, db } from './config.js'; 
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
        import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

        let currentUser = null;
        const loader = document.getElementById('page-loader');
        const headerAppName = document.getElementById('headerAppName');

        // Resume Data Storage (In Memory)
        let resumeData = { education: [], experience: [] };
        
        // Drawer Logic
        const menuTrigger = document.getElementById('menuTrigger');
        const sideDrawer = document.getElementById('sideDrawer');
        const menuOverlay = document.getElementById('menuOverlay');
        const logoutBtn = document.getElementById('logoutBtn');
        const drawerName = document.getElementById('drawerName');
        const drawerAvatar = document.getElementById('drawerAvatar');

        function toggleDrawer() {
            sideDrawer.classList.toggle('active');
            menuOverlay.classList.toggle('active');
        }
        menuTrigger.addEventListener('click', toggleDrawer);
        menuOverlay.addEventListener('click', toggleDrawer);
        document.querySelectorAll('.drawer-item').forEach(l => l.addEventListener('click', toggleDrawer));
        logoutBtn.addEventListener('click', async () => await signOut(auth));

        // Scale Logic for Preview
        let scale = 0.65;
        const previewEl = document.getElementById('resumePreview');
        window.zoomIn = () => { scale = Math.min(scale + 0.1, 1.2); updateScale(); }
        window.zoomOut = () => { scale = Math.max(scale - 0.1, 0.35); updateScale(); }
        function updateScale() { previewEl.style.transform = `scale(${scale})`; }
        // Responsive initial scale
        if(window.innerWidth < 1100) scale = 0.48;
        updateScale();

        // AUTH & INIT
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // Drawer Info
                const uDoc = await getDoc(doc(db, "users", user.uid));
                const name = user.displayName || (uDoc.exists() ? uDoc.data().fullName : "Member");
                drawerName.textContent = name;
                drawerAvatar.textContent = name.charAt(0).toUpperCase();

                await loadAppConfig();
                await loadResumeData(user.uid);
                
                // Pre-fill basic info if fields are empty
                if(!document.getElementById('inpName').value) document.getElementById('inpName').value = name;
                if(!document.getElementById('inpEmail').value) document.getElementById('inpEmail').value = user.email || "";
                
                updatePreview();
                setTimeout(()=> { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none',500); }, 500);
            } else {
                window.location.href = "signin.html";
            }
        });

        // LOAD CONFIG
        async function loadAppConfig() {
            try {
                const brandSnap = await getDoc(doc(db, "settings", "branding"));
                if (brandSnap.exists()) {
                    const data = brandSnap.data();
                    headerAppName.textContent = data.appName || 'Hatua Recruitment';
                    if(data.primaryColor) document.documentElement.style.setProperty('--primary-dark', data.primaryColor);
                }
            } catch (e) {}
        }

        // LOAD RESUME FROM FIRESTORE
        async function loadResumeData(uid) {
            try {
                const docSnap = await getDoc(doc(db, "resumes", uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Static Fields
                    document.getElementById('inpName').value = data.fullName || "";
                    document.getElementById('inpRole').value = data.jobTitle || "";
                    document.getElementById('inpEmail').value = data.email || "";
                    document.getElementById('inpPhone').value = data.phone || "";
                    document.getElementById('inpLoc').value = data.location || "";
                    document.getElementById('inpLink').value = data.link || "";
                    document.getElementById('inpSummary').value = data.summary || "";
                    document.getElementById('inpSkills').value = data.skills || "";
                    
                    // Arrays
                    resumeData.education = data.education || [];
                    resumeData.experience = data.experience || [];
                }
                
                // Render the dynamic lists based on loaded data
                renderEducationList();
                renderExperienceList();
                
            } catch(e) { console.error("Load Error", e); }
        }

        // SAVE RESUME TO FIRESTORE
        window.saveResume = async () => {
            if(!currentUser) return;
            
            // Collect latest values from inputs
            updateDataFromDOM(); 

            const data = {
                userId: currentUser.uid,
                fullName: document.getElementById('inpName').value,
                jobTitle: document.getElementById('inpRole').value,
                email: document.getElementById('inpEmail').value,
                phone: document.getElementById('inpPhone').value,
                location: document.getElementById('inpLoc').value,
                link: document.getElementById('inpLink').value,
                summary: document.getElementById('inpSummary').value,
                skills: document.getElementById('inpSkills').value,
                education: resumeData.education,
                experience: resumeData.experience,
                updatedAt: new Date()
            };

            try {
                await setDoc(doc(db, "resumes", currentUser.uid), data);
                Toastify({text: "Resume Draft Saved!", style: {background: "var(--success-green)", borderRadius:"50px"}}).showToast();
            } catch(e) {
                console.error(e);
                Toastify({text: "Error saving data.", style: {background: "var(--danger-red)", borderRadius:"50px"}}).showToast();
            }
        };

        // UI: ACCORDION
        window.toggleSection = (id, btn) => {
            // Close all others
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.section-trigger').forEach(el => el.classList.remove('active'));
            
            // Open clicked
            const content = document.getElementById(id);
            if(content) {
                content.classList.add('open');
                if(btn) btn.classList.add('active');
            }
        };

        // ============================================
        //      DYNAMIC EDUCATION LOGIC
        // ============================================

        const eduListContainer = document.getElementById('eduListContainer');
        const addEduBtn = document.getElementById('addEduBtn');

        // 1. Add New Education Item
        addEduBtn.addEventListener('click', () => {
            // Add empty object to array
            resumeData.education.push({ school: "", degree: "", year: "" });
            renderEducationList();
            updatePreview();
        });

        // 2. Render List
        function renderEducationList() {
            eduListContainer.innerHTML = "";
            resumeData.education.forEach((edu, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'dynamic-list-item';
                itemDiv.innerHTML = `
                    <button class="remove-btn" onclick="removeEducationItem(${index})"><i class="fas fa-trash"></i></button>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>School / University</label>
                            <input type="text" class="edu-school" data-index="${index}" value="${edu.school}" oninput="updateEducationField(${index}, 'school', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Degree</label>
                            <input type="text" class="edu-degree" data-index="${index}" value="${edu.degree}" oninput="updateEducationField(${index}, 'degree', this.value)">
                        </div>
                        <div class="form-group full">
                            <label>Year / Duration</label>
                            <input type="text" class="edu-year" data-index="${index}" value="${edu.year}" placeholder="e.g. 2018 - 2022" oninput="updateEducationField(${index}, 'year', this.value)">
                        </div>
                    </div>
                `;
                eduListContainer.appendChild(itemDiv);
            });
        }

        // 3. Update Specific Field
        window.updateEducationField = (index, field, value) => {
            resumeData.education[index][field] = value;
            updatePreview();
        };

        // 4. Remove Item
        window.removeEducationItem = (index) => {
            resumeData.education.splice(index, 1);
            renderEducationList();
            updatePreview();
        };

        // ============================================
        //      DYNAMIC EXPERIENCE LOGIC
        // ============================================

        const expListContainer = document.getElementById('expListContainer');
        const addExpBtn = document.getElementById('addExpBtn');

        // 1. Add New Experience Item
        addExpBtn.addEventListener('click', () => {
            resumeData.experience.push({ company: "", role: "", date: "", desc: "" });
            renderExperienceList();
            updatePreview();
        });

        // 2. Render List
        function renderExperienceList() {
            expListContainer.innerHTML = "";
            resumeData.experience.forEach((exp, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'dynamic-list-item';
                itemDiv.innerHTML = `
                    <button class="remove-btn" onclick="removeExperienceItem(${index})"><i class="fas fa-trash"></i></button>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company</label>
                            <input type="text" class="exp-company" value="${exp.company}" oninput="updateExperienceField(${index}, 'company', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Job Title</label>
                            <input type="text" class="exp-role" value="${exp.role}" oninput="updateExperienceField(${index}, 'role', this.value)">
                        </div>
                        <div class="form-group full">
                            <label>Date Range</label>
                            <input type="text" class="exp-date" value="${exp.date}" placeholder="e.g. Jan 2020 - Present" oninput="updateExperienceField(${index}, 'date', this.value)">
                        </div>
                        <div class="form-group full">
                            <label>Description</label>
                            <textarea class="exp-desc" oninput="updateExperienceField(${index}, 'desc', this.value)">${exp.desc}</textarea>
                        </div>
                    </div>
                `;
                expListContainer.appendChild(itemDiv);
            });
        }

        // 3. Update Specific Field
        window.updateExperienceField = (index, field, value) => {
            resumeData.experience[index][field] = value;
            updatePreview();
        };

        // 4. Remove Item
        window.removeExperienceItem = (index) => {
            resumeData.experience.splice(index, 1);
            renderExperienceList();
            updatePreview();
        };

        // Helper to sync before save (optional double check)
        function updateDataFromDOM() {
            // Arrays are already kept in sync via oninput events
            // but we can ensure integrity if needed here.
            // Currently relies on resumeData state.
        }

        // ============================================
        //      LIVE PREVIEW RENDERER
        // ============================================
        window.updatePreview = () => {
            // Header
            document.getElementById('prevName').innerText = document.getElementById('inpName').value || "YOUR NAME";
            document.getElementById('prevRole').innerText = document.getElementById('inpRole').value || "PROFESSIONAL TITLE";
            
            // Contact
            const email = document.getElementById('inpEmail').value || "email@example.com";
            const phone = document.getElementById('inpPhone').value || "+254...";
            const loc = document.getElementById('inpLoc').value || "City, Country";
            const link = document.getElementById('inpLink').value || "linkedin.com";

            document.getElementById('prevEmail').innerHTML = `${email} <i class="fas fa-envelope"></i>`;
            document.getElementById('prevPhone').innerHTML = `${phone} <i class="fas fa-phone"></i>`;
            document.getElementById('prevLoc').innerHTML = `${loc} <i class="fas fa-map-marker-alt"></i>`;
            document.getElementById('prevLink').innerHTML = `${link} <i class="fab fa-linkedin"></i>`;
            
            // Summary
            document.getElementById('prevSummary').innerText = document.getElementById('inpSummary').value || "Professional summary goes here...";

            // Skills
            const skillsStr = document.getElementById('inpSkills').value;
            const skillsContainer = document.getElementById('prevSkills');
            skillsContainer.innerHTML = "";
            if(skillsStr) {
                skillsStr.split(',').forEach(s => {
                    if(s.trim()) {
                        const span = document.createElement('span');
                        span.className = 'res-skill-tag';
                        span.innerText = s.trim();
                        skillsContainer.appendChild(span);
                    }
                });
            }

            // Experience Preview
            const expContainer = document.getElementById('prevExpList');
            expContainer.innerHTML = "";
            resumeData.experience.forEach(e => {
                if(e.company || e.role) {
                    expContainer.innerHTML += `
                        <div class="res-item">
                            <div class="res-item-head">
                                <span class="res-item-title">${e.role}</span>
                                <span class="res-item-date">${e.date}</span>
                            </div>
                            <div class="res-item-sub">${e.company}</div>
                            <div class="res-desc">${e.desc}</div>
                        </div>`;
                }
            });

            // Education Preview
            const eduContainer = document.getElementById('prevEduList');
            eduContainer.innerHTML = "";
            resumeData.education.forEach(e => {
                if(e.school || e.degree) {
                    eduContainer.innerHTML += `
                        <div class="res-item">
                            <div class="res-item-head">
                                <span class="res-item-title">${e.degree}</span>
                                <span class="res-item-date">${e.year}</span>
                            </div>
                            <div class="res-item-sub">${e.school}</div>
                        </div>`;
                }
            });
        };

        // PDF DOWNLOAD
        window.downloadPDF = () => {
            const element = document.getElementById('resumePreview');
            // Store current style
            const originalTransform = element.style.transform;
            const originalBoxShadow = element.style.boxShadow;
            
            // Reset for capture
            element.style.transform = "scale(1)";
            element.style.boxShadow = "none";
            element.style.margin = "0";
            
            // Wait for DOM update
            setTimeout(() => {
                const opt = {
                    margin: 0,
                    filename: `Resume_${document.getElementById('inpName').value}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    // Restore style
                    element.style.transform = originalTransform;
                    element.style.boxShadow = originalBoxShadow;
                    // Trigger resize to fix any margins
                    if(window.innerWidth < 1100) updateScale();
                    Toastify({text: "PDF Downloaded", style: {background: "var(--primary-dark)", borderRadius:"50px"}}).showToast();
                });
            }, 100);
        };

    </script>
</body>
</html>
